name: Deploy Indexers and API Gateway to Railway

on:
  push:
    branches: [dev, main]
    paths:
      - "apps/indexer/**/*.ts"

jobs:
  get-daos:
    runs-on: ubuntu-latest
    outputs:
      daos: ${{ steps.get-daos.outputs.daos }}
    steps:
      - uses: actions/checkout@v3
      - name: Get available DAOs
        id: get-daos
        run: |
          # Extract DAO names from config files (excluding local configs)
          daos=$(ls apps/indexer/config/*.config.ts | grep -v test | grep -v arbitrum | grep -v zk | sed 's/.*\/\([^.]*\)\.config\.ts/\1/')

          # Create DAO array
          dao_array="["
          for dao in $daos; do
            dao_array="${dao_array}\"${dao}\","
          done
          dao_array="${dao_array%,}]"

          echo "daos=$dao_array" >> $GITHUB_OUTPUT
          echo "Detected DAOs: $dao_array"

  environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
      railway_token: ${{ steps.determine.outputs.railway_token }}
    steps:
      - name: Determine environment and token
        id: determine
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          echo "Deploying to: $([ '${{ github.ref }}' == 'refs/heads/main' ] && echo 'production' || echo 'dev')"

  deploy-indexers:
    needs: [get-daos, changes, environment]
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    environment: ${{ needs.environment.outputs.environment }}
    strategy:
      matrix:
        dao: ${{ fromJson(needs.get-daos.outputs.daos) }}
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      - name: Deploy ${{ matrix.dao }}-indexer
        run: |
          echo "Deploying ${{ matrix.dao }}-indexer to ${{ needs.environment.outputs.environment }}"
          railway up -s ${{ matrix.dao }}-indexer -e ${{ needs.environment.outputs.environment }} --ci -d
